{% extends "movies/base.html" %}
{% load static %}
{% block title %}{{ movie.title }} â€¢ Dusa Films{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'movies/css/detail.css' %}">
{% endblock %}

{% block content %}
<div class="movie-wrapper">

    <!-- Hidden playlist data -->
    <div id="playlistData" data-playlist='{{ playlist_json|safe }}' style="display: none;"></div>

    <!-- MOVIE INFO -->
    <div class="movie-title">{{ movie.title }}</div>
    <div class="movie-meta">
        {{ movie.category.name }} â€¢ {{ movie.time_ago }} â€¢ 
        <span id="commentsCount">{{ movie.comments_count }}</span> comments
    </div>

    <!-- VIDEO -->
    <div class="video-box">
        {% if movie.video_url %}
            <video id="mainPlayer" 
                playsinline 
                webkit-playsinline 
                preload="metadata"
                {% if movie.thumbnail %}
                    poster="{{ movie.thumbnail.url }}"
                {% else %}
                    poster="https://via.placeholder.com/1280x720?text=No+Thumbnail"
                {% endif %}
                style="width: 100%; display: block;"
                aria-label="Movie player for {{ movie.title }}"
                aria-describedby="videoDescription"
            >
                <source src="{{ movie.video_url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            
            <!-- Progress bar for upcoming video -->
            <div class="upcoming-progress" id="upcomingProgress" style="display: none;">
                <div class="upcoming-progress-bar" id="upcomingProgressBar"></div>
            </div>
            
            <!-- Hidden video description for accessibility -->
            <div id="videoDescription" hidden>
                Movie titled {{ movie.title }}, category: {{ movie.category.name }}
            </div>
        {% endif %}
    </div>

    <!-- BUTTONS -->
    <div class="buttons">
        {% if movie.video_url %}
            <a href="{{ movie.video_url }}" target="_blank" class="btn-primary-custom">
                <i class="bi bi-fullscreen"></i> Watch in Fullscreen
            </a>
        {% endif %}
        {% if movie.download_link %}
            <a href="{{ movie.download_link }}" class="btn-download" download>
                <i class="bi bi-download"></i> Download
            </a>
        {% endif %}
        
        <!-- Autoplay settings -->
        <div class="autoplay-settings">
            <label class="autoplay-toggle">
                <input type="checkbox" id="autoplayToggle" checked>
                <span>Autoplay next</span>
            </label>
        </div>
        
        <!-- Playlist toggle button -->
        <button id="playlistToggle" class="btn-primary-custom">
            <i class="bi bi-list"></i> Playlist
        </button>
    </div>

    <!-- DESCRIPTION -->
    <div class="section-title">Description</div>
    <div class="movie-description">{{ movie.description|linebreaks }}</div>

    <!-- COMMENTS -->
    <div class="section-title">
        Comments (<span id="commentsCountInline">{{ movie.comments_count }}</span>)
    </div>

    <form id="commentForm" method="POST" action="{% url 'movies:add_comment' movie.slug %}">
        {% csrf_token %}
        <textarea name="text" 
                  id="commentText" 
                  placeholder="Write your comment..."
                  aria-label="Comment text area"
                  aria-describedby="commentHelp"
                  maxlength="1000"></textarea>
        <div id="commentHelp" hidden>Maximum 1000 characters allowed</div>
        <button id="submitComment" class="btn-submit" type="submit">Post Comment</button>
    </form>

    <!-- ðŸ”¥ SCROLLABLE COMMENTS -->
    <div id="commentsList">
        {% for c in comments %}
            <div class="comment-box">
                <div class="comment-author">
                    {% if c.user %}
                        {{ c.user.username }}
                    {% else %}
                        {{ c.guest_name }}
                    {% endif %}
                </div>
                <div class="comment-time">{{ c.time_ago }}</div>
                <div class="comment-text">{{ c.text }}</div>
            </div>
        {% empty %}
            <p style="color:#9ca3af;">No comments yet. Be the first!</p>
        {% endfor %}
    </div>

    <!-- RELATED MOVIES -->
    {% if related %}
        <div class="section-title">Related Movies</div>
        <div class="grid">
            {% for m in related %}
                <a href="{% url 'movies:detail' m.slug %}" class="movie-card" data-movie-id="{{ m.id }}">
                    {% if m.thumbnail %}
                        <img src="{{ m.thumbnail.url }}" 
                             class="movie-thumb" 
                             loading="lazy"
                             alt="{{ m.title }} thumbnail">
                    {% else %}
                        <img src="https://via.placeholder.com/300x400?text=No+Image" 
                             class="movie-thumb" 
                             loading="lazy"
                             alt="{{ m.title }} thumbnail">
                    {% endif %}
                    <div class="movie-info">
                        <div class="movie-title-small">{{ m.title }}</div>
                        <div class="movie-meta-small">{{ m.time_ago }} â€¢ {{ m.comments_count }} comments</div>
                    </div>
                </a>
            {% endfor %}
        </div>
    {% endif %}

</div>

<!-- Playlist Sidebar -->
<div class="playlist-sidebar" id="playlistSidebar" style="display: none;">
    <h4>Up Next in {{ movie.category.name }}</h4>
    <div id="playlistItems"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'movies/js/detail.js' %}"></script>
{% endblock %}