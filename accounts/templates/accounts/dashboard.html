{% extends "movies/base.html" %}
{% load static %}
{% block title %}Dashboard - Dusa Films{% endblock %}

{% block content %}
<div class="container">

  <!-- ===== HEADER WITH PROFILE ===== -->
  <div class="dashboard-header d-flex align-items-center justify-content-between mb-4 flex-wrap gap-3">

    <!-- Left: Profile -->
    <div class="d-flex align-items-center gap-3 flex-wrap profile-header">
      {% if profile.profile_photo %}
        <img src="{{ profile.profile_photo.url }}" class="profile-photo" alt="Profile">
      {% else %}
        <img src="{% static 'img/user-default.png' %}" class="profile-photo" alt="Profile">
      {% endif %}

      <div class="profile-text">
        <h2 class="fw-bold mb-1">Hello, {{ request.user.username }} üëã</h2>
        <p class="text-muted small mb-0">Welcome to your activity dashboard</p>
      </div>
    </div>

    <!-- Right: Upload profile photo -->
    <form method="POST" enctype="multipart/form-data" class="text-end upload-form">
      {% csrf_token %}
      {{ photo_form.profile_photo }}
      <button class="btn btn-outline-light btn-sm mt-1 w-100">Update Photo</button>
    </form>

  </div>

  <!-- ===== STATS GRID ===== -->
  <div class="row g-4 mb-4">

    <div class="col-lg-4 col-md-6 col-12">
      <div class="studio-card">
        <div class="studio-icon bg-primary">üìù</div>
        <div>
          <p class="studio-label">Total Comments</p>
          <h2 class="studio-value">{{ total_comments }}</h2>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-md-6 col-12">
      <div class="studio-card">
        <div class="studio-icon bg-success">üçø</div>
        <div>
          <p class="studio-label">Movies Watched</p>
          <h2 class="studio-value">{{ movies_watched }}</h2>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-md-12 col-12">
      <div class="studio-card">
        <div class="studio-icon bg-info">üßë‚Äçüíª</div>
        <div>
          <p class="studio-label">Account Status</p>
          <h2 class="studio-value text-success">Active</h2>
        </div>
      </div>
    </div>

  </div>

  <!-- ===== ACTION BUTTON ===== -->
  <div class="row g-3 mb-5">
    <div class="col-12">
      <a href="{% url 'movies:home' %}" class="btn btn-primary w-100 py-3">
        üé¨ Browse Movies
      </a>
    </div>
  </div>

  <!-- ===== TWO-COLUMN ACTIVITY SECTION ===== -->
  <div class="row g-4">

    <div class="col-lg-6 col-12">
      <div class="panel-box">
        <h5 class="fw-bold mb-3">üí¨ Recent Comments</h5>

        {% if recent_comments %}
          <ul class="list-group list-group-flush">
            {% for c in recent_comments %}
              <li class="list-group-item bg-transparent d-flex justify-content-between align-items-start panel-item flex-wrap gap-2">
                <div>
                  <div class="fw-bold">{{ c.movie.title }}</div>
                  <div class="text-muted small">{{ c.text|truncatechars:100 }}</div>
                </div>
                <div class="small text-muted">{{ c.time_ago }} ago</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No comments yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-6 col-12">
      <div class="panel-box">
        <h5 class="fw-bold mb-3">‚è±Ô∏è Recently Watched</h5>

        {% if recent_watched %}
          <ul class="list-group list-group-flush">
            {% for w in recent_watched %}
              <li class="list-group-item bg-transparent d-flex justify-content-between align-items-start panel-item flex-wrap gap-2">
                <div>
                  <a href="{% url 'movies:detail' w.movie.slug %}" class="fw-bold">{{ w.movie.title }}</a>
                  <div class="text-muted small">{{ w.watched_at|date:"M d, Y H:i" }}</div>
                </div>
                <span class="small text-muted">View</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No watched activity yet.</p>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- ===== TOP COMMENTED MOVIES ===== -->
  <div class="panel-box mt-4">
    <h5 class="fw-bold mb-3">üìä Top Commented Movies</h5>

    {% if top_commented %}
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        {% for t in top_commented %}
          <div class="col">
            <div class="top-movie-card">
              <div>
                <a href="{% url 'movies:detail' t.movie__slug %}" class="fw-bold">
                  {{ t.movie__title }}
                </a>
                <p class="text-muted small">{{ t.cnt }} comments</p>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No data yet.</p>
    {% endif %}
  </div>

</div>

<!-- ===== CUSTOM STYLES ===== -->
<style>
  .profile-photo {
    width: 85px;
    height: 85px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #1e90ff;
  }

  .studio-card {
    background: #111;
    padding: 18px;
    border-radius: 14px;
    display: flex;
    gap: 15px;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.08);
    transition: 0.2s ease;
  }

  .studio-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 26px;
  }

  .panel-box {
    background: #0d1117;
    padding: 20px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.08);
  }

  .top-movie-card {
    background: #111;
    padding: 18px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
  }

  /* ===== MOBILE RESPONSIVE ===== */
  @media (max-width: 768px) {
    .dashboard-header {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .profile-header {
      justify-content: center;
      text-align: center;
    }

    .profile-text h2 {
      font-size: 1.5rem;
    }

    .upload-form {
      width: 100%;
    }

    .studio-value {
      font-size: 1.5rem;
    }
  }
</style>

{% endblock %}
